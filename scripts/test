#!/bin/bash
safeRunCommand() {
  typeset cmd="$*"
  typeset ret_code

  echo cmd="$cmd"
  eval "$cmd"

  ret_code=$?
  if [ $ret_code != 0 ]; then
    printf "Error : [%d] when executing command: '$cmd'" $ret_code
    exit $ret_code
  fi
}

# ara node_modules/.bin to PATH
PATH=$(npm bin):$PATH

# move deploy identity to home dir
mkdir -p ~/.ara/identities/
chmod +r ~/.ara/identities/
cp -a test/fixtures/identities/. ~/.ara/identities/

# installation
if ! which ganache-cli > /dev/null; then
  npm install -g ganache-cli truffle@5.3.1
fi

# run local ganache node
pkill -f ganache
ganache-cli -l 0x7A1200  &
pid=$!
sleep 5

command="truffle migrate --reset --network local"
safeRunCommand "$command"
sleep 20

# truffle test

command="ava test/util.js --verbose"
safeRunCommand "$command"

command="ava test/token.js --verbose"
safeRunCommand "$command"

command="ava test/registry.js --verbose"
safeRunCommand "$command"

command="ava test/purchase.js --verbose"
safeRunCommand "$command"

command="ava test/library.js --verbose"
safeRunCommand "$command"

command="ava test/storage.js --verbose"
safeRunCommand "$command"

command="ava test/ownership.js --verbose"
safeRunCommand "$command"

command="ava test/rewards.js --verbose"
safeRunCommand "$command"

command="ava test/factory.js --verbose"
safeRunCommand "$command"

# cleanup
pkill -f ganache
kill -9 "$pid"
