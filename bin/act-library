#!/usr/bin/env node

const debug = require('debug')('ara-contracts:cli:library')
const { info, warn, error, log } = require('ara-console')
const { createProgram } = require('../lib/program')
const library = require('../library')
const inquirer = require('inquirer')

const toLower = x => String(x).toLowerCase()

// yargs program command line interface instance
const program = createProgram({
  usage: `
usage: act library: [-h] [--help]
                     <did> [options]
`
})

const { argv } = program
  .command('$0 <did>', 'Gets a list of content DIDs purchased by <did>', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The library owner\'s DID'
      })
  }, onall)
  .command('get-copies <owner> <did> [--config]', 'Gets the number of copies of an AFS a purchaser owns', () => {
    program
      .positional('owner', {
        type: 'string',
        describe: 'The AFS owner\'s DID'
      })
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
      .option('config', {
        alias: 'c',
        type: 'string',
        describe: 'The seller resale config ID'
      })
  }, oncopies)

// Emit program usage help
if (0 == argv._.length && argv.help) {
  program.showHelp()
  process.exit(0)
}

// Main program entry
module.exports = (async function main() {
  if (argv.debug) {
    require('debug').enable('ara-contracts*')
  }
}())

async function onall(argv) {
  const { did } = argv
  try {
    info(`Getting ${did}\'s library...`)
    const size = await library.getLibrarySize(did)
    const lib = await library.getLibrary(did)
    info(`${did} library (${size})\n${lib}.`)
  } catch (err) {
    onfatal(err)
  }
}

async function oncopies(argv) {
  const { owner, did, config } = argv

  try {
    if (config) {
      info(`Getting number of copies of ${did} owned by ${owner} with resale config ${config}...`)
    } else {
      info(`Getting number of copies of ${did} owned by ${owner}...`)
    }
    let opts = { purchaserDid: owner, contentDid: did }
    if (config) {
      opts = Object.assign(opts, { config })
    }
    const copies = await library.getNumberCopiesOwned(opts)
    if (config) {
      info(`${owner} owns ${copies} copies of ${did} with resale config ${config}.`)
    } else {
      info(`${owner} owns ${copies} copies of ${did}.`)
    }
  } catch (err) {
    onfatal(err)
  }
}

function onfatal(err) {
  if (err) {
    debug(err)
    error("fatal:", err.message)
  }
  process.exit(1)
}
