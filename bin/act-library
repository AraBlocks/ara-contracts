#!/usr/bin/env node

const debug = require('debug')('ara-contracts:cli:library')
const { info, warn, error, log } = require('ara-console')
const { createProgram } = require('../lib/program')
const library = require('../library')
const inquirer = require('inquirer')

const toLower = x => String(x).toLowerCase()

// yargs program command line interface instance
const program = createProgram({
  usage: `
usage: act library: [-h] [--help]
                     <did> [options]
`
})

const { argv } = program
  .command('$0 <did>', 'Gets a list of content DIDs purchased by <did>', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The library owner\'s DID'
      })
  }, onall)
  .command('get <did> <index>', 'Gets the content DID at <index> in <did>\'s library', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The library owner\'s DID'
      })
      .positional('index', {
        type: 'number',
        describe: 'The position in the library'
      })
  }, onget)

// Emit program usage help
if (0 == argv._.length && argv.help) {
  program.showHelp()
  process.exit(0)
}

// Main program entry
module.exports = (async function main() {
  if (argv.debug) {
    require('debug').enable('ara-contracts*')
  }
}())

async function onall(argv) {
  const { did } = argv
  try {
    const size = await library.getLibrarySize(did)
    const lib = await library.getLibrary(did)
    info(did, 'library (', size, ')\n', lib)
  } catch (err) {
    onfatal(err)
  }
}

async function onget(argv) {
  const { did, index } = argv
  try {
    const contentDid = await library.getLibraryItem({ requesterDid: did, index })
    info('item', index, 'has did:', contentDid)
  } catch (err) {
    onfatal(err)
  }
}
