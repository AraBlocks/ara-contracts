#!/usr/bin/env node

const debug = require('debug')('ara-contracts:cli:resale')
const { info, warn, error, log } = require('ara-console')
const { createProgram } = require('../lib/program')
const inquirer = require('inquirer')

const {
  getResaleAvailability,
  unlockResaleQuantity,
  lockResaleQuantity,
  setMinResalePrice,
  getMinResalePrice,
  setResaleQuantity,
  getResaleQuantity,
  getResaleConfig,
  setResalePrice,
  getResalePrice,
  unlockResale,
  lockResale
} = require('../commerce')

// yargs program command line interface instance
const program = createProgram({
  usage: `
usage: act resale: [-h] [--help] [options] [--] <command>
`
})

const { argv } = program
  .command('set-price [--seller|config] <did> <price>', 'Set the (minimum) resale price of an AFS. If the seller option is not passed in, the minimum resale price will be set.', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
      .positional('price', {
        type: 'string',
        describe: 'The resale price to set for the AFS'
      })
      .option('seller', {
        alias: 's',
        type: 'string',
        describe: 'DID of the AFS seller (if the seller is not also the AFS owner)'
      })
      .option('config', {
        alias: 'c',
        type: 'string',
        describe: 'The seller resale config ID'
      })
      .implies('seller', 'config')
  }, onprice)
  .command('set-quantity <did> <amount>', 'Set the number of times an AFS can be resold', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
      .positional('amount', {
        type: 'number',
        describe: 'The number of times the AFS can be resold'
      })
  }, onquantity)
  .command('get-price [--seller|config] <did>', 'Get the (minimum) resale price of an AFS. If the seller option is not passed in, the minimum resale price will be returned.', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
      .option('seller', {
        alias: 's',
        type: 'string',
        describe: 'DID of the AFS seller (if the seller is not also the AFS owner)'
      })
      .option('config', {
        alias: 'c',
        type: 'string',
        describe: 'The seller resale config ID'
      })
      .implies('seller', 'config')
  }, ongetprice)
  .command('get-quantity [--seller|config] <did>', 'Get the number of time an AFS can be resold. If the seller option is passed in, the seller\'s available supply will be returned.', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
      .option('seller', {
        alias: 's',
        type: 'string',
        describe: 'The seller DID (if not the AFS owner)'
      })
      .option('config', {
        alias: 'c',
        type: 'string',
        describe: 'The seller resale config ID'
      })
      .implies('seller', 'config')
    }, ongetquantity)
  .command('lock <did>', 'Locks an AFS from resale', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
  }, onlock)
  .command('unlock <did>', 'Unlocks an AFS for resale', () => {
    program
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
  }, onunlock)
  .command('lock-quantity <seller> <config> <did> <quantity>', 'Locks a number of purchased AFSs from resale', () => {
    program
      .positional('seller', {
        type: 'string',
        describe: 'The seller DID'
      })
      .positional('config', {
        type: 'string',
        describe: 'The seller resale config ID'
      })
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
      .positional('quantity', {
        type: 'number',
        describe: 'The number of AFSs to lock from resale'
      })
  }, onlockquantity)
  .command('unlock-quantity <seller> <config> <did> <quantity>', 'Unlocks a number of purchased AFSs for resale', () => {
    program
      .positional('seller', {
        type: 'string',
        describe: 'The seller DID'
      })
      .positional('config', {
        type: 'string',
        describe: 'The seller resale config ID'
      })
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
      .positional('quantity', {
        type: 'number',
        describe: 'The number of AFSs to unlock for resale'
      })
  }, onunlockquantity)
  .command('get-config <seller> <config> <did>', 'Returns a resale configuration', () => {
    program
      .positional('seller', {
        type: 'string',
        describe: 'The seller DID'
      })
      .positional('config', {
        type: 'string',
        describe: 'The seller resale config ID'
      })
      .positional('did', {
        type: 'string',
        describe: 'The AFS DID'
      })
  }, ongetconfig)

// Emit program usage help
if (0 == argv._.length && argv.help) {
  program.showHelp()
  process.exit(0)
}

module.exports = (async function main() {
  if (argv.debug) {
    require('debug').enable('ara-contracts*')
  }
}())

async function onprice(argv) {
  const { did, price, seller, config } = argv
  const { password } = await promptForPassword()

  try {
    let receipt
    if (seller) {
      info(`Setting the resale price for ${did} from seller ${seller} to ${price} Ara...`)
      await setResalePrice({
        requesterDid: seller,
        contentDid: did,
        password,
        configID: config,
        price
      })
      info(`Resale price for ${did} from seller ${seller} successfully set to ${price} Ara.`)
    } else {
      info(`Setting the minimum resale price for ${did} to ${price} Ara...`)
      await setMinResalePrice({
        contentDid: did,
        password,
        price
      })
      info(`Minimum resale price for ${did} successfully set to ${price} Ara.`)
    }
  } catch (err) {
    onfatal(err)
  }
}

async function onquantity(argv) {
  const { did, amount } = argv
  const { password } = await promptForPassword()

  try {
    info(`Setting resale quantity for ${did} to ${amount}...`)
    await setResaleQuantity({
      contentDid: did,
      password,
      maxResales: amount
    })
    info(`Resale quantity for ${did} successfully set to ${amount}.`)
  } catch (err) {
    onfatal(err)
  }
}

async function ongetprice(argv) {
  const { did, seller, config } = argv

  try {
    let price
    if (seller) {
      info(`Getting resale price for ${did} from seller ${seller}...`)
      price = await getResalePrice({
        contentDid: did,
        sellerDid: seller,
        configID: config
      })
      info(`Resale price for ${did} from seller ${seller} is ${price} Ara.`)
    } else {
      info(`Getting minimum resale price for ${did}...`)
      price = await getMinResalePrice({
        contentDid: did
      })
      info(`Minimum resale price for ${did} is ${price} Ara.`)
    }
  } catch (err) {
    onfatal(err)
  }
}

async function ongetquantity(argv) {
  const { did, seller, config } = argv

  try {
    let quantity
    if (seller) {
      info(`Getting quantity of ${did} available for purchase from ${seller}...`)
      quantity = await getResaleAvailability({
        contentDid: did,
        sellerDid: seller,
        configID: config
      })
      info(`${seller} has ${quantity} copies of ${did} available for purchase.`)
    } else {
      info(`Getting maximum number of times ${did} can be resold...`)
      quantity = await getResaleQuantity({
        contentDid: did
      })
      info(`${did} can be resold ${quantity} times.`)
    }
  } catch (err) {
    onfatal(err)
  }
}

async function onlock(argv) {
  const { did } = argv
  const { password } = await promptForPassword()

  try {
    info (`Locking AFS ${did} from resale...`)
    await lockResale({
      contentDid: did,
      password
    })
    info (`AFS ${did} locked from resale.`)
  } catch (err) {
    onfatal(err)
  }
}

async function onunlock(argv) {
  const { did } = argv
  const { password } = await promptForPassword()

  try {
    info (`Unlocking AFS ${did} from resale...`)
    await unlockResale({
      contentDid: did,
      password
    })
    info (`AFS ${did} unlocked from resale.`)
  } catch (err) {
    onfatal(err)
  }
}

async function onlockquantity(argv) {
  const { seller, did, quantity, config } = argv
  const { password } = await promptForPassword()

  try {
    info(`Locking ${quantity} copies of ${did} from resale by seller ${seller}...`)
    await lockResaleQuantity({
      requesterDid: seller,
      contentDid: did,
      password,
      quantity,
      configID: config
    })
    info(`${quantity} copies of ${did} locked from resale by seller ${seller}.`)
  } catch (err) {
    onfatal(err)
  }
}

async function onunlockquantity(argv) {
  const { seller, did, quantity, config } = argv
  const { password } = await promptForPassword()

  try {
    info(`Unlocking ${quantity} copies of ${did} for resale by seller ${seller}...`)
    await unlockResaleQuantity({
      requesterDid: seller,
      contentDid: did,
      password,
      quantity,
      configID: config
    })
    info(`${quantity} copies of ${did} unlocked for resale by seller ${seller}.`)
  } catch (err) {
    onfatal(err)
  }
}

async function ongetconfig(argv) {
  const { seller, did, config } = argv

  try {
    // act resale get-config 77da0a6389fd2942d30c794c7a7dd61c97d7f7b0ee3a795100d171404f9073e0 0xde63a8f44964c2c060b346b24adc91b3065f7d9cf79b0c89d6bf5871726b65e5 196ebd2be2ecac1c7ee2593be97c3c25af7326565a8fe3835be496814dc6792f
    info(`Getting resale config ${config} in AFS ${did} from seller ${seller}...`)
    let resaleConfig = await getResaleConfig({
      sellerDid: seller,
      contentDid: did,
      configID: config
    })
    info(`\nResale config ${config}:\n
    {\n\t
      Minimum resale price: ${resaleConfig.minResalePrice} Ara\n\t
      Maximum # of resales: ${resaleConfig.maxNumResales}\n\n\t
      Resale Price: ${resaleConfig.resalePrice} Ara\n\t
      # available for resale: ${resaleConfig.available}\n\t
      # owned total: ${resaleConfig.quantity}\n
    }`)
  } catch (err) {
    onfatal(err)
  }
}

async function promptForPassword() {
  return await inquirer.prompt([{
    type: 'password',
    name: 'password',
    message:
    'Please provide the passphrase for your identity. This is needed to ' +
    'complete this action.\n' +
    'Passphrase:'
  }]) 
}

function onfatal(err) {
  if (err) {
    debug(err)
    error('fatal:', err.message)
  }
  process.exit(1)
}
