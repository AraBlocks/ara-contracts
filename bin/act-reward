#!/usr/bin/env node

const debug = require('debug')('ara-contracts:cli:reward')
const { info, warn, error, log } = require('ara-console')
const { createProgram } = require('../lib/program')
const rewards = require('../rewards')
const inquirer = require('inquirer')

// yargs program command line interface instance
const program = createProgram({
  usage: `
usage: act reward: [-h] [--help] [options]
`
})

const { argv } = program
  .option('allocate', {
    alias: 'a',
    descirbe: 'Flag to allocate rewards.'
  })
  .option('balance', {
    alias: 'b',
    describe: 'Flag to acquire balance.'
  })
  .option('content', {
    alias: 'c',
    describe: 'The AFS did of the content.'
  })
  .option('did', {
    alias: 'd',
    describe: 'The requester did.'
  })
  .option('job', {
    alias: 'j',
    describe: 'The job Id.'
  })
  .option('redeem', {
    alias: 'r',
    describe: 'Flag to redeem balance.'
  })
  .option('submit', {
    alias: 's',
    describe: 'Flag to submit budget for job.'
  })
  .conflicts('a', ['b', 'r', 's'])
  .conflicts('b', ['a', 'r', 's'])
  .conflicts('r', ['a', 'b', 's'])
  .conflicts('s', ['a', 'b', 'r'])

// Emit program usage help
if (0 == argv._.length && argv.help) {
  program.showHelp()
  process.exit(0)
}

// Main program entry
module.exports = (async function main() {
  const { allocate, balance, redeem, submit, job: jobId } = argv
  let { content, did } = argv
  if (allocate) {
    const jobId = '0x3df61fc4147aace69841a5058cd4683f788a48ccfa14c9c92dae021ba2206421'
    const farmers = ['0xF9403C6DA32DB4860F1eCB1c02B9A04D37c0e36e',
                     '0x70693d8f4e1c9bA1AE0870C35128BaDfDcF28FBc',
                     '0x19d6a7D8bB09e8A6d733a9c8D9fe7b964fD8F45e',
                     '0x629483C72b5191C1b522E887238a0A522b1D4F74']
    const distrib = [10, 20, 30, 40]
    await rewards.allocate({ requesterDid: 'did:ara:4e56ed331bb52ae28f18969982275bb156f81f4b23c22115e9ddd2b51b4c89c4',
                             contentDid: '9861d0eafe27e080c5804b8f3de1aa762af4b4eb69a91b38a4cf87afbb52d643',
                             password: 'pass',
                             job: {
                              jobId,
                              farmers,
                              rewards: distrib
                             }})
  } else if (balance) {
    if (!content) {
      ({ did: content } = await promptForDID('Please provide the DID of the AFS.'))
    }
    if (!did) {
      ({ did } = await promptForDID('Please provide the requester DID.'))
    }

    const { password } = await promptForPassword()
    try {
      const balance = await rewards.getBalance({ requesterDid: did, contentDid: content, password })
      info(did, 'balance in AFS', content, 'is', balance, 'tokens.')
    } catch (err) {
      throw err
    }
  } else if (redeem) {
    if (!content) {
      ({ did: content } = await promptForDID('Please provide the DID of the AFS.'))
    }
    if (!did) {
      ({ did } = await promptForDID('Please provide the requester DID.'))
    }

    const { password } = await promptForPassword()
    try {
      const balance = await rewards.redeem({ requesterDid: did, contentDid: content, password })
      info(did, 'redeemed', balance, 'tokens from AFS', contentDid)
    } catch (err) {
      throw err
    }
  } else if (submit) {
    if (!content) {
      ({ did: content } = await promptForDID('Please provide the DID of the AFS.'))
    }
    if (!did) {
      ({ did } = await promptForDID('Please provide the requester DID.'))
    }
    if (!jobId) {
      ({ jobId } = await promptForJobID())
    }

    const { budget } = await promptForBudget()
    const { password } = await promptForPassword()
    try {
      await rewards.submit({ requesterDid: did, contentDid: content, password, job: { jobId, budget } })
      info('submitted', budget, 'tokens as rewards for AFS', contentDid)
    } catch (err) {
      throw err
    }
  } else if (content && jobId) {
    try {
      const budget = await rewards.getBudget({ contentDid: content, jobId })
      info('budget for job', jobId, 'is', budget, 'tokens')
    } catch (err) {
      throw err
    }
  } else {
    program.showHelp()
    process.exit(0)
  }
}())

async function promptForDID(message) {
  return await inquirer.prompt([{
    name: 'did',
    message
  }])
}

async function promptForJobId() {
  return await inquirer.prompt([{
    name: 'jobId',
    message:
    "Please provide an existing Job ID.\n" +
    "Job ID:"
  }]) 
}

async function promptForBudget() {
  return await inquirer.prompt([{
    name: 'budget',
    type: 'number',
    message:
    "Please provide a budget in Ara tokens as rewards for the job.\n" +
    "Budget:"
  }]) 
}

async function promptForPassword() {
  return await inquirer.prompt([{
    type: 'password',
    name: 'password',
    message:
    "Please provide the passphrase for your identity. This is needed to " +
    "complete this action.\n" +
    "Passphrase:"
  }]) 
}

function onfatal(err) {
  if (err) {
    debug(err)
    error("fatal:", err.message)
  }
  process.exit(1)
}
