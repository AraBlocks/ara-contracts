#!/usr/bin/env node

const debug = require('debug')('ara-contracts:cli:purchase')
const { info, warn, error, log } = require('ara-console')
const { createProgram } = require('../lib/program')
const { randomBytes } = require('ara-crypto')
const { purchase } = require('../purchase')
const { ethify } = require('../util')
const inquirer = require('inquirer')

// yargs program command line interface instance
const program = createProgram({
  usage: `
usage: act purchase: [-h] [--help] [options]
`
})

const { argv } = program
  .option('purchaser', {
    alias: 'p',
    describe: 'The purchaser DID.'
  })
  .option('did', {
    alias: 'd',
    describe: 'The content DID to purchase.'
  })
  .option('job', {
    alias: 'j',
    type: 'boolean',
    describe: 'Flag to indicate if a new job should be created.'
  })

// Emit program usage help
if (0 == argv._.length && argv.help) {
  program.showHelp()
  process.exit(0)
}

// Main program entry
module.exports = (async function main() {
  let { purchaser, did, job } = argv

  if (!purchaser) {
    onfatal(new Error("Please provide the DID of the purchaser. See 'act purchase --help'."))
    process.exit(0)
  }
  if (!did) {
    onfatal(new Error("Please provide a content DID to purchase. See 'act purchase --help'."))
    process.exit(0)
  }

  const { password } = await promptForPassword()

  let jobId
  if (!job) {
    ({ jobId } = await promptForJobId())
  }
  const { budget } = await promptForBudget()

  info('purchasing', did)
  try {
    // DEBUG=* act purchase -j -p 4e56ed331bb52ae28f18969982275bb156f81f4b23c22115e9ddd2b51b4c89c4 -d b7f0dc137958c82c1b486d8155d9718b2777c81da2f042cbac12ab60aef44241
    await purchase({
      requesterDid: purchaser,
      contentDid: did,
      password,
      job: job ? { jobId: ethify(randomBytes(32), true), budget } : { jobId, budget }
    })
  } catch (err) {
    onfatal(err)
  }
}())

async function promptForPassword() {
  return await inquirer.prompt([{
    type: 'password',
    name: 'password',
    message:
    "Please provide the passphrase for your identity. This is needed to " +
    "complete this action.\n" +
    "Passphrase:"
  }]) 
}

async function promptForJobId() {
  return await inquirer.prompt([{
    name: 'jobId',
    message:
    "Please provide an existing Job ID.\n" +
    "Job ID:"
  }]) 
}

async function promptForBudget() {
  return await inquirer.prompt([{
    name: 'budget',
    type: 'number',
    message:
    "Please provide a budget in Ara tokens as rewards for the job.\n" +
    "Budget:"
  }]) 
}

function onfatal(err) {
  if (err) {
    debug(err)
    error("fatal:", err.message)
  }
  process.exit(1)
}
